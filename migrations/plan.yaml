# yaml-language-server: $schema=../.moose/migration_schema.json

created_at: 2025-08-20T05:02:37.341820Z
operations:
  - RawSql:
      sql:
        - DROP VIEW IF EXISTS source_to_rollup_mv
      description: Running teardown SQL for resource source_to_rollup_mv
  - AddTableColumn:
      table: source_table
      column:
        name: event_type
        data_type: String
        required: true
        unique: false
        primary_key: false
        default: null
        annotations: []
      after_column: created_at
  - RawSql:
      sql:
        - "ALTER TABLE source_table UPDATE event_type = 'purchase' WHERE event_type IS NULL"
      description: Run backfill SQL for resource source_table
  - RawSql:
      sql:
        - "CREATE MATERIALIZED VIEW IF NOT EXISTS source_to_rollup_mv \n        TO rollup_table\n        AS \n  SELECT \n    toStartOfDay(`created_at`) as day, \n    `color`, \n    sumIf(`price`, `event_type` = 'purchase') - sumIf(`price`, `event_type` = 'refund') as total_sales,\n    avg(`price`) as avg_price\n  FROM `source_table` \n  GROUP BY day, color"
        - "INSERT INTO rollup_table\n          \n  SELECT \n    toStartOfDay(`created_at`) as day, \n    `color`, \n    sumIf(`price`, `event_type` = 'purchase') - sumIf(`price`, `event_type` = 'refund') as total_sales,\n    avg(`price`) as avg_price\n  FROM `source_table` \n  GROUP BY day, color"
      description: Running setup SQL for resource source_to_rollup_mv
